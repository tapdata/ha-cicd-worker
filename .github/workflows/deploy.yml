name: Tapdata Config Deployment

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - lpt
          - preprod
          - prod
      project_group:
        description: 'Project Group'
        required: true
        type: choice
        options:
          - patients
          - hospital

env:
  SHARED_DIR: /tmp/tapdata-deploy-${{ github.run_id }}

jobs:
  prepare:
    name: Prepare Configuration
    runs-on: self-hosted
    timeout-minutes: 5
    outputs:
      config_repo: ${{ steps.get_repo.outputs.repo }}
      base_url: ${{ steps.get_url.outputs.base_url }}
      tar_path: ${{ steps.create_tar.outputs.tar_path }}
      access_token: ${{ steps.get_token.outputs.access_token }}
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create shared directory
        run: |
          mkdir -p ${{ env.SHARED_DIR }}
          echo "Shared directory: ${{ env.SHARED_DIR }}"

      - name: Get config repository name
        id: get_repo
        run: |
          REPO=$(grep "^${{ inputs.project_group }}=" conf/project.conf | cut -d'=' -f2)
          if [ -z "$REPO" ]; then
            echo "Error: Config repository not found for project group ${{ inputs.project_group }}"
            exit 1
          fi
          echo "Config repository: $REPO"
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: Checkout config repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.get_repo.outputs.repo }}
          ref: main
          path: config-repo
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create tar archive from config repository
        id: create_tar
        run: |
          TAR_PATH="${{ env.SHARED_DIR }}/config.tar"
          CONFIG_SUBDIR="${{ inputs.project_group }}_tapdata_export"

          # Check if the subdirectory exists
          if [ ! -d "config-repo/$CONFIG_SUBDIR" ]; then
            echo "âŒ Error: Required subdirectory '$CONFIG_SUBDIR' not found in config repository"
            echo "Available directories in config-repo:"
            ls -la config-repo/
            exit 1
          fi

          # Check if there are any JSON files in the subdirectory
          if ! ls config-repo/$CONFIG_SUBDIR/*.json 1> /dev/null 2>&1; then
            echo "âŒ Error: No JSON files found in subdirectory '$CONFIG_SUBDIR'"
            exit 1
          fi

          # Enter the subdirectory and pack all json files to ensure they are at the first level of tar
          cd config-repo/$CONFIG_SUBDIR
          tar -cf "$TAR_PATH" *.json
          cd ../..

          echo "âœ“ Successfully created tar archive from $CONFIG_SUBDIR"
          ls -lh "$TAR_PATH"
          echo "Verify tar contents:"
          tar -tf "$TAR_PATH"
          echo "tar_path=$TAR_PATH" >> $GITHUB_OUTPUT

      - name: Get Tapdata URL
        id: get_url
        run: |
          BASE_URL=$(grep "^${{ inputs.env }}=" conf/env.conf | cut -d'=' -f2)
          if [ -z "$BASE_URL" ]; then
            echo "Error: Tapdata URL not found for environment ${{ inputs.env }}"
            exit 1
          fi
          echo "Tapdata URL: $BASE_URL"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Get Access Token
        id: get_token
        run: |
          ACCESS_TOKEN=$(python scripts/tapdata-get-token.py "${{ steps.get_url.outputs.base_url }}")
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "Error: Failed to get access_token"
            exit 1
          fi
          echo "âœ“ Successfully obtained access_token"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

  import:
    name: Import Configuration
    runs-on: self-hosted
    timeout-minutes: 20
    needs: prepare
    outputs:
      record_id: ${{ steps.import.outputs.record_id }}
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Import configuration to Tapdata
        id: import
        run: |
          python scripts/tapdata-import.py \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.prepare.outputs.access_token }}" \
            "${{ needs.prepare.outputs.tar_path }}"

  verify:
    name: Verify Result
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [prepare, import]
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Check import status
        id: verify_status
        run: |
          python scripts/tapdata-check.py \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.prepare.outputs.access_token }}" \
            "${{ needs.import.outputs.record_id }}"

#      - name: Clean up shared directory
#        if: always()
#        run: |
#          if [ -d "${{ env.SHARED_DIR }}" ]; then
#            rm -rf "${{ env.SHARED_DIR }}"
#            echo "Cleaned up shared directory: ${{ env.SHARED_DIR }}"
#          fi

  report:
    name: Generate Report
    runs-on: self-hosted
    timeout-minutes: 2
    if: always()
    needs: [prepare, import, verify]
    steps:
      - name: Generate deployment report
        run: |
          # Determine overall deployment status (for report content, does not affect this job's success/failure)
          if [ "${{ needs.prepare.result }}" == "success" ] && \
             [ "${{ needs.import.result }}" == "success" ] && \
             [ "${{ needs.verify.result }}" == "success" ]; then
            OVERALL_STATUS="success"
            STATUS_ICON="âœ…"
            STATUS_TEXT="Success"
          else
            OVERALL_STATUS="failure"
            STATUS_ICON="âŒ"
            STATUS_TEXT="Failed"
          fi

          # Output to GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Tapdata Configuration Deployment Report

          ## ${STATUS_ICON} Overall Status: ${STATUS_TEXT}

          ### ðŸ”§ Deployment Information
          | Item | Value |
          |------|-------|
          | Environment | \`${{ inputs.env }}\` |
          | Project Group | \`${{ inputs.project_group }}\` |
          | Config Repository | \`${{ needs.prepare.outputs.config_repo }}\` |
          | Tapdata URL | ${{ needs.prepare.outputs.base_url }} |
          | Triggered By | @${{ github.actor }} |
          | Run Number | #${{ github.run_number }} |

          ### ðŸ“‹ Execution Results
          | Job | Status |
          |-----|--------|
          | Prepare Configuration | ${{ needs.prepare.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | Import Configuration | ${{ needs.import.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | Verify Result | ${{ needs.verify.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |

          EOF

          # Add related links
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ”— Related Links
          - [Workflow Run Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          if [ "${{ needs.import.outputs.record_id }}" != "" ]; then
            echo "- Import Record ID: \`${{ needs.import.outputs.record_id }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Add time information
          END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          cat >> $GITHUB_STEP_SUMMARY << EOF

          ### â° Time Information
          - Completion Time: ${END_TIME}

          ---
          *Report Generated At: ${END_TIME}*
          EOF

          # Output to console log
          echo "=========================================="
          echo "ðŸ“Š Tapdata Configuration Deployment Report"
          echo "=========================================="
          echo ""
          echo "Overall Deployment Status: ${STATUS_ICON} ${STATUS_TEXT}"
          echo "Environment: ${{ inputs.env }}"
          echo "Project Group: ${{ inputs.project_group }}"
          echo ""
          echo "âœ… Report generated successfully! Detailed report has been output to GitHub Actions Summary"
          echo "=========================================="

          # Note: Do not exit based on deployment status, this job succeeds as long as report generation succeeds
          # This way, even if previous steps fail, the report job will still show as successful (green)
