name: Tapdataé…ç½®éƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev
          - lpt
          - preprod
          - prod
      project_group:
        description: 'é¡¹ç›®åˆ†ç»„'
        required: true
        type: choice
        options:
          - patient
          - hospital

env:
  SHARED_DIR: /tmp/tapdata-deploy-${{ github.run_id }}

jobs:
  prepare:
    name: å‡†å¤‡é…ç½®
    runs-on: self-hosted
    timeout-minutes: 5
    outputs:
      config_repo: ${{ steps.get_repo.outputs.repo }}
      base_url: ${{ steps.get_url.outputs.base_url }}
      tar_path: ${{ steps.create_tar.outputs.tar_path }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»ºå…±äº«ç›®å½•
        run: |
          mkdir -p ${{ env.SHARED_DIR }}
          echo "å…±äº«ç›®å½•: ${{ env.SHARED_DIR }}"

      - name: è·å–é…ç½®ä»“åº“åç§°
        id: get_repo
        run: |
          REPO=$(grep "^${{ inputs.project_group }}=" ha-cicd-worker/conf/project.conf | cut -d'=' -f2)
          if [ -z "$REPO" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°é¡¹ç›®åˆ†ç»„ ${{ inputs.project_group }} çš„é…ç½®ä»“åº“"
            exit 1
          fi
          echo "é…ç½®ä»“åº“: $REPO"
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: æ£€å‡ºé…ç½®ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.get_repo.outputs.repo }}
          ref: main
          path: config-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‹ç¼©é…ç½®ä»“åº“ä¸ºtar
        id: create_tar
        run: |
          cd config-repo
          TAR_PATH="${{ env.SHARED_DIR }}/config.tar.gz"
          tar -czf "$TAR_PATH" .
          cd ..
          ls -lh "$TAR_PATH"
          echo "tar_path=$TAR_PATH" >> $GITHUB_OUTPUT

      - name: è·å–Tapdataåœ°å€
        id: get_url
        run: |
          BASE_URL=$(grep "^${{ inputs.env }}=" ha-cicd-worker/conf/env.conf | cut -d'=' -f2)
          if [ -z "$BASE_URL" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¯å¢ƒ ${{ inputs.env }} çš„Tapdataåœ°å€"
            exit 1
          fi
          echo "Tapdataåœ°å€: $BASE_URL"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT

  import:
    name: å¯¼å…¥é…ç½®
    runs-on: self-hosted
    timeout-minutes: 20
    needs: prepare
    outputs:
      record_id: ${{ steps.import.outputs.record_id }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å¯¼å…¥é…ç½®åˆ°Tapdata
        id: import
        run: |
          chmod +x ha-cicd-worker/scripts/tapdata-import.sh
          ha-cicd-worker/scripts/tapdata-import.sh \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.prepare.outputs.tar_path }}"

  verify:
    name: éªŒè¯ç»“æœ
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [prepare, import]
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¯¼å…¥çŠ¶æ€
        id: verify_status
        run: |
          chmod +x ha-cicd-worker/scripts/tapdata-check.sh
          ha-cicd-worker/scripts/tapdata-check.sh \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.import.outputs.record_id }}"

      - name: æ¸…ç†å…±äº«ç›®å½•
        if: always()
        run: |
          if [ -d "${{ env.SHARED_DIR }}" ]; then
            rm -rf "${{ env.SHARED_DIR }}"
            echo "å·²æ¸…ç†å…±äº«ç›®å½•: ${{ env.SHARED_DIR }}"
          fi

  report:
    name: ç”ŸæˆæŠ¥å‘Š
    runs-on: self-hosted
    timeout-minutes: 2
    if: always()
    needs: [prepare, import, verify]
    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "=========================================="
          echo "ğŸ“Š Tapdata é…ç½®éƒ¨ç½²æŠ¥å‘Š"
          echo "=========================================="
          echo ""
          echo "ğŸ”§ éƒ¨ç½²ä¿¡æ¯"
          echo "  ç¯å¢ƒ: ${{ inputs.env }}"
          echo "  é¡¹ç›®åˆ†ç»„: ${{ inputs.project_group }}"
          echo "  é…ç½®ä»“åº“: ${{ needs.prepare.outputs.config_repo }}"
          echo "  Tapdata åœ°å€: ${{ needs.prepare.outputs.base_url }}"
          echo "  è¿è¡Œ ID: ${{ github.run_id }}"
          echo "  è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "  è§¦å‘è€…: ${{ github.actor }}"
          echo ""
          echo "ğŸ“‹ æ‰§è¡Œç»“æœ"
          echo "  Job 1 (å‡†å¤‡é…ç½®): ${{ needs.prepare.result }}"
          echo "  Job 2 (å¯¼å…¥é…ç½®): ${{ needs.import.result }}"
          echo "  Job 3 (éªŒè¯ç»“æœ): ${{ needs.verify.result }}"
          echo ""

          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          if [ "${{ needs.prepare.result }}" == "success" ] && \
             [ "${{ needs.import.result }}" == "success" ] && \
             [ "${{ needs.verify.result }}" == "success" ]; then
            echo "âœ… æ•´ä½“çŠ¶æ€: æˆåŠŸ"
            echo ""
            echo "ğŸ‰ é…ç½®å·²æˆåŠŸéƒ¨ç½²åˆ° ${{ inputs.env }} ç¯å¢ƒï¼"
            OVERALL_STATUS="success"
          else
            echo "âŒ æ•´ä½“çŠ¶æ€: å¤±è´¥"
            echo ""
            echo "ğŸ’¡ å¤±è´¥åŸå› åˆ†æ:"
            if [ "${{ needs.prepare.result }}" != "success" ]; then
              echo "  - å‡†å¤‡é…ç½®é˜¶æ®µå¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä»“åº“æ˜¯å¦å­˜åœ¨æˆ–é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®"
            fi
            if [ "${{ needs.import.result }}" != "success" ]; then
              echo "  - å¯¼å…¥é…ç½®é˜¶æ®µå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Tapdata API æ˜¯å¦å¯è®¿é—®æˆ– access_token æ˜¯å¦æœ‰æ•ˆ"
            fi
            if [ "${{ needs.verify.result }}" != "success" ]; then
              echo "  - éªŒè¯ç»“æœé˜¶æ®µå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£å¯¼å…¥å¤±è´¥çš„è¯¦ç»†åŸå› "
            fi
            OVERALL_STATUS="failure"
          fi

          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥"
          echo "  Workflow è¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "${{ needs.import.outputs.record_id }}" != "" ]; then
            echo "  å¯¼å…¥è®°å½• ID: ${{ needs.import.outputs.record_id }}"
          fi
          echo ""
          echo "â° æ—¶é—´ä¿¡æ¯"
          echo "  å¼€å§‹æ—¶é—´: $(date -d @$((${{ github.event.repository.updated_at }} / 1000)) '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo 'æœªçŸ¥')"
          echo "  ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "=========================================="

          # æ ¹æ®çŠ¶æ€é€€å‡º
          if [ "$OVERALL_STATUS" == "failure" ]; then
            exit 1
          fi
