name: Tapdataé…ç½®éƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'çŽ¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev
          - lpt
          - preprod
          - prod
      project_group:
        description: 'é¡¹ç›®åˆ†ç»„'
        required: true
        type: choice
        options:
          - patient
          - hospital

env:
  SHARED_DIR: /tmp/tapdata-deploy-${{ github.run_id }}

jobs:
  prepare:
    name: å‡†å¤‡é…ç½®
    runs-on: self-hosted
    timeout-minutes: 5
    outputs:
      config_repo: ${{ steps.get_repo.outputs.repo }}
      base_url: ${{ steps.get_url.outputs.base_url }}
      tar_path: ${{ steps.create_tar.outputs.tar_path }}
      access_token: ${{ steps.get_token.outputs.access_token }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»ºå…±äº«ç›®å½•
        run: |
          mkdir -p ${{ env.SHARED_DIR }}
          echo "å…±äº«ç›®å½•: ${{ env.SHARED_DIR }}"

      - name: èŽ·å–é…ç½®ä»“åº“åç§°
        id: get_repo
        run: |
          REPO=$(grep "^${{ inputs.project_group }}=" conf/project.conf | cut -d'=' -f2)
          if [ -z "$REPO" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°é¡¹ç›®åˆ†ç»„ ${{ inputs.project_group }} çš„é…ç½®ä»“åº“"
            exit 1
          fi
          echo "é…ç½®ä»“åº“: $REPO"
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: æ£€å‡ºé…ç½®ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.get_repo.outputs.repo }}
          ref: main
          path: config-repo
          token: ${{ secrets.PAT_TOKEN }}

      - name: åŽ‹ç¼©é…ç½®ä»“åº“ä¸ºtar
        id: create_tar
        run: |
          cd config-repo
          TAR_PATH="${{ env.SHARED_DIR }}/config.tar"
          tar -czf "$TAR_PATH" .
          cd ..
          ls -lh "$TAR_PATH"
          echo "tar_path=$TAR_PATH" >> $GITHUB_OUTPUT

      - name: èŽ·å–Tapdataåœ°å€
        id: get_url
        run: |
          BASE_URL=$(grep "^${{ inputs.env }}=" conf/env.conf | cut -d'=' -f2)
          if [ -z "$BASE_URL" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°çŽ¯å¢ƒ ${{ inputs.env }} çš„Tapdataåœ°å€"
            exit 1
          fi
          echo "Tapdataåœ°å€: $BASE_URL"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt

      - name: èŽ·å– Access Token
        id: get_token
        run: |
          ACCESS_TOKEN=$(python scripts/tapdata-get-token.py "${{ steps.get_url.outputs.base_url }}")
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "é”™è¯¯ï¼šèŽ·å– access_token å¤±è´¥"
            exit 1
          fi
          echo "âœ“ æˆåŠŸèŽ·å– access_token"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

  import:
    name: å¯¼å…¥é…ç½®
    runs-on: self-hosted
    timeout-minutes: 20
    needs: prepare
    outputs:
      record_id: ${{ steps.import.outputs.record_id }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt

      - name: å¯¼å…¥é…ç½®åˆ°Tapdata
        id: import
        run: |
          python scripts/tapdata-import.py \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.prepare.outputs.access_token }}" \
            "${{ needs.prepare.outputs.tar_path }}"

  verify:
    name: éªŒè¯ç»“æžœ
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [prepare, import]
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt

      - name: æ£€æŸ¥å¯¼å…¥çŠ¶æ€
        id: verify_status
        run: |
          python scripts/tapdata-check.py \
            "${{ needs.prepare.outputs.base_url }}" \
            "${{ needs.prepare.outputs.access_token }}" \
            "${{ needs.import.outputs.record_id }}"

      - name: æ¸…ç†å…±äº«ç›®å½•
        if: always()
        run: |
          if [ -d "${{ env.SHARED_DIR }}" ]; then
            rm -rf "${{ env.SHARED_DIR }}"
            echo "å·²æ¸…ç†å…±äº«ç›®å½•: ${{ env.SHARED_DIR }}"
          fi

  report:
    name: ç”ŸæˆæŠ¥å‘Š
    runs-on: self-hosted
    timeout-minutes: 2
    if: always()
    needs: [prepare, import, verify]
    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          # åˆ¤æ–­æ•´ä½“éƒ¨ç½²çŠ¶æ€ï¼ˆç”¨äºŽæŠ¥å‘Šå†…å®¹ï¼Œä¸å½±å“æ­¤ job çš„æˆåŠŸ/å¤±è´¥ï¼‰
          if [ "${{ needs.prepare.result }}" == "success" ] && \
             [ "${{ needs.import.result }}" == "success" ] && \
             [ "${{ needs.verify.result }}" == "success" ]; then
            OVERALL_STATUS="success"
            STATUS_ICON="âœ…"
            STATUS_TEXT="æˆåŠŸ"
          else
            OVERALL_STATUS="failure"
            STATUS_ICON="âŒ"
            STATUS_TEXT="å¤±è´¥"
          fi

          # è¾“å‡ºåˆ° GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Tapdata é…ç½®éƒ¨ç½²æŠ¥å‘Š

          ## ${STATUS_ICON} æ•´ä½“çŠ¶æ€: ${STATUS_TEXT}

          ### ðŸ”§ éƒ¨ç½²ä¿¡æ¯
          | é¡¹ç›® | å€¼ |
          |------|-----|
          | çŽ¯å¢ƒ | \`${{ inputs.env }}\` |
          | é¡¹ç›®åˆ†ç»„ | \`${{ inputs.project_group }}\` |
          | é…ç½®ä»“åº“ | \`${{ needs.prepare.outputs.config_repo }}\` |
          | Tapdata åœ°å€ | ${{ needs.prepare.outputs.base_url }} |
          | è§¦å‘è€… | @${{ github.actor }} |
          | è¿è¡Œç¼–å· | #${{ github.run_number }} |

          ### ðŸ“‹ æ‰§è¡Œç»“æžœ
          | Job | çŠ¶æ€ |
          |-----|------|
          | å‡†å¤‡é…ç½® | ${{ needs.prepare.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | å¯¼å…¥é…ç½® | ${{ needs.import.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | éªŒè¯ç»“æžœ | ${{ needs.verify.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |

          EOF

          # æ·»åŠ ç›¸å…³é“¾æŽ¥
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          - [Workflow è¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          if [ "${{ needs.import.outputs.record_id }}" != "" ]; then
            echo "- å¯¼å…¥è®°å½• ID: \`${{ needs.import.outputs.record_id }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          # æ·»åŠ æ—¶é—´ä¿¡æ¯
          END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          cat >> $GITHUB_STEP_SUMMARY << EOF

          ### â° æ—¶é—´ä¿¡æ¯
          - ç»“æŸæ—¶é—´: ${END_TIME}

          ---
          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${END_TIME}*
          EOF

          # åŒæ—¶è¾“å‡ºåˆ°æŽ§åˆ¶å°æ—¥å¿—
          echo "=========================================="
          echo "ðŸ“Š Tapdata é…ç½®éƒ¨ç½²æŠ¥å‘Š"
          echo "=========================================="
          echo ""
          echo "éƒ¨ç½²æ•´ä½“çŠ¶æ€: ${STATUS_ICON} ${STATUS_TEXT}"
          echo "çŽ¯å¢ƒ: ${{ inputs.env }}"
          echo "é¡¹ç›®åˆ†ç»„: ${{ inputs.project_group }}"
          echo ""
          echo "âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼è¯¦ç»†æŠ¥å‘Šå·²è¾“å‡ºåˆ° GitHub Actions Summary"
          echo "=========================================="

          # æ³¨æ„ï¼šä¸å†æ ¹æ®éƒ¨ç½²çŠ¶æ€é€€å‡ºï¼Œåªè¦æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼Œæ­¤ job å°±æˆåŠŸ
          # è¿™æ ·å³ä½¿å‰é¢çš„æ­¥éª¤å¤±è´¥ï¼ŒæŠ¥å‘Š job ä¹Ÿä¼šæ˜¾ç¤ºä¸ºæˆåŠŸï¼ˆç»¿è‰²ï¼‰
