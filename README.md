# ha-cicd

[![GitHub Actions](https://img.shields.io/badge/CI%2FCD-GitHub%20Actions-2088FF?logo=github-actions&logoColor=white)](https://github.com/features/actions)
[![Self-Hosted Runner](https://img.shields.io/badge/Runner-Self--Hosted-green)](https://docs.github.com/en/actions/hosting-your-own-runners)

## ğŸ“– é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºè¿è¡Œ GitHub Actions çš„ CI/CD è‡ªåŠ¨åŒ–ä»“åº“ã€‚

è¯¥ä»“åº“ä¸»è¦ç”¨äºé›†ä¸­ç®¡ç†å’Œæ‰§è¡Œ CI/CD è‡ªåŠ¨åŒ–æµç¨‹ï¼Œä½œä¸ºè‡ªåŠ¨åŒ–æ‰§è¡Œä¸­æ¢ï¼Œè´Ÿè´£è§¦å‘ã€ç¼–æ’å¹¶è¿è¡Œå„ç±»æµæ°´çº¿ä»»åŠ¡ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- ğŸ¯ **èŒè´£å•ä¸€**ï¼šä»…è´Ÿè´£ CI/CD æµç¨‹ç¼–æ’ï¼Œä¸æ‰¿è½½ä¸šåŠ¡ä»£ç 
- ğŸ”„ **é›†ä¸­ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰è‡ªåŠ¨åŒ–å·¥ä½œæµå’Œè„šæœ¬
- ğŸš€ **è‡ªæ‰˜ç®¡è¿è¡Œ**ï¼šä½¿ç”¨ self-hosted runnerï¼Œæ”¯æŒå†…ç½‘ç¯å¢ƒ
- ğŸ“¦ **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»ç®¡ç†å¤šç¯å¢ƒã€å¤šé¡¹ç›®

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
ha-cicd/
â”œâ”€â”€ ha-cicd-worker/              # CI/CD å·¥ä½œæµå’Œè„šæœ¬
â”‚   â”œâ”€â”€ conf/                    # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ env.conf            # ç¯å¢ƒé…ç½®ï¼ˆdev/lpt/preprod/prodï¼‰
â”‚   â”‚   â””â”€â”€ project.conf        # é¡¹ç›®åˆ†ç»„é…ç½®
â”‚   â”œâ”€â”€ scripts/                 # è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ tapdata-import.sh   # Tapdata é…ç½®å¯¼å…¥è„šæœ¬
â”‚   â”‚   â””â”€â”€ tapdata-check.sh    # Tapdata å¯¼å…¥çŠ¶æ€æ£€æŸ¥è„šæœ¬
â”‚   â””â”€â”€ README.md               # æœ¬æ–‡æ¡£
â”œâ”€â”€ ha-cicd-patient/             # æ‚£è€…ç«¯é…ç½®ä»“åº“ï¼ˆç¤ºä¾‹ï¼‰
â””â”€â”€ .github/
    â””â”€â”€ workflows/               # GitHub Actions å·¥ä½œæµå®šä¹‰
        â”œâ”€â”€ deploy.yml          # Tapdata é…ç½®éƒ¨ç½²å·¥ä½œæµ
        â””â”€â”€ deploy-README.md    # å·¥ä½œæµè¯¦ç»†æ–‡æ¡£
```

---

## ğŸš€ ä¸»è¦åŠŸèƒ½

### 1. Tapdata é…ç½®éƒ¨ç½²

è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®åˆ° Tapdata å¹³å°ï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šé¡¹ç›®åˆ†ç»„ã€‚

**æ”¯æŒçš„ç¯å¢ƒï¼š**
- `dev` - å¼€å‘ç¯å¢ƒ
- `lpt` - æµ‹è¯•ç¯å¢ƒ
- `preprod` - é¢„ç”Ÿäº§ç¯å¢ƒ
- `prod` - ç”Ÿäº§ç¯å¢ƒ

**æ”¯æŒçš„é¡¹ç›®åˆ†ç»„ï¼š**
- `patient` - æ‚£è€…ç«¯é¡¹ç›®
- `hospital` - åŒ»é™¢ç«¯é¡¹ç›®

**ä½¿ç”¨æ–¹å¼ï¼š**
1. è¿›å…¥ GitHub Actions é¡µé¢
2. é€‰æ‹© "tapdataé…ç½®éƒ¨ç½²" workflow
3. ç‚¹å‡» "Run workflow"
4. é€‰æ‹©ç¯å¢ƒå’Œé¡¹ç›®åˆ†ç»„
5. ç‚¹å‡» "Run workflow" å¼€å§‹æ‰§è¡Œ

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼š[Tapdata é…ç½®éƒ¨ç½² Workflow æ–‡æ¡£](.github/workflows/deploy-README.md)

---

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

### 1. ç¯å¢ƒé…ç½® (`conf/env.conf`)

å®šä¹‰å„ç¯å¢ƒçš„ Tapdata æœåŠ¡åœ°å€ã€‚

**æ ¼å¼ï¼š** `ç¯å¢ƒ=Tapdataåœ°å€`

**ç¤ºä¾‹ï¼š**
```properties
dev=http://dev.tapdata.com:3030
lpt=http://111.229.51.170:3030
preprod=http://preprod.tapdata.com:3030
prod=http://prod.tapdata.com:3030
```

### 2. é¡¹ç›®é…ç½® (`conf/project.conf`)

å®šä¹‰é¡¹ç›®åˆ†ç»„ä¸é…ç½®ä»“åº“çš„æ˜ å°„å…³ç³»ã€‚

**æ ¼å¼ï¼š** `é¡¹ç›®åˆ†ç»„=ä»“åº“åç§°`

**ç¤ºä¾‹ï¼š**
```properties
patient=tapdata/ha-cicd-patient
hospital=tapdata/ha-cicd-hospital
```

---

## ğŸ› ï¸ è„šæœ¬è¯´æ˜

### 1. tapdata-import.sh

**åŠŸèƒ½ï¼š** å¯¼å…¥é…ç½®åˆ° Tapdata å¹³å°

**ä¸»è¦æ­¥éª¤ï¼š**
1. è·å– Tapdata access_token
2. ä¸Šä¼ é…ç½® tar åŒ…
3. è¿”å›å¯¼å…¥ä»»åŠ¡ record_id

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./scripts/tapdata-import.sh <BASE_URL> <TAR_FILE>
```

**å‚æ•°ï¼š**
- `BASE_URL`: Tapdata æœåŠ¡åœ°å€
- `TAR_FILE`: é…ç½® tar åŒ…è·¯å¾„

### 2. tapdata-check.sh

**åŠŸèƒ½ï¼š** æ£€æŸ¥ Tapdata å¯¼å…¥ä»»åŠ¡çŠ¶æ€

**ä¸»è¦æ­¥éª¤ï¼š**
1. å¾ªç¯æ£€æŸ¥å¯¼å…¥çŠ¶æ€ï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
2. å¤„ç†ä¸åŒçŠ¶æ€ï¼šimportingï¼ˆå¯¼å…¥ä¸­ï¼‰ã€completedï¼ˆæˆåŠŸï¼‰ã€failedï¼ˆå¤±è´¥ï¼‰
3. æ ¼å¼åŒ–è¾“å‡ºé”™è¯¯ä¿¡æ¯

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
./scripts/tapdata-check.sh <BASE_URL> <RECORD_ID>
```

**å‚æ•°ï¼š**
- `BASE_URL`: Tapdata æœåŠ¡åœ°å€
- `RECORD_ID`: å¯¼å…¥ä»»åŠ¡ ID

---

## ğŸ”§ æŠ€æœ¯æ ˆ

- **CI/CD å¹³å°**: GitHub Actions
- **è¿è¡Œç¯å¢ƒ**: Self-Hosted Runner
- **è„šæœ¬è¯­è¨€**: Bash
- **æ•°æ®ä¼ é€’**: å…±äº«æ–‡ä»¶ç³»ç»Ÿ + Job Outputs
- **API è°ƒç”¨**: curl

---

## ğŸ“‹ å·¥ä½œæµç¨‹

ä»¥ Tapdata é…ç½®éƒ¨ç½²ä¸ºä¾‹ï¼š

```
1. å‡†å¤‡é…ç½® (prepare)
   â”œâ”€ æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
   â”œâ”€ åˆ›å»ºå…±äº«ç›®å½•
   â”œâ”€ è·å–é…ç½®ä»“åº“åç§°ï¼ˆä» project.confï¼‰
   â”œâ”€ æ£€å‡ºé…ç½®ä»“åº“ä»£ç 
   â”œâ”€ å‹ç¼©é…ç½®ä»“åº“ä¸º tar.gz
   â””â”€ è·å– Tapdata åœ°å€ï¼ˆä» env.confï¼‰

2. å¯¼å…¥é…ç½® (import)
   â”œâ”€ æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
   â”œâ”€ è°ƒç”¨ tapdata-import.sh
   â”œâ”€ è·å– access_token
   â”œâ”€ ä¸Šä¼  tar æ–‡ä»¶
   â””â”€ è¿”å› record_id

3. éªŒè¯ç»“æœ (verify)
   â”œâ”€ æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
   â”œâ”€ è°ƒç”¨ tapdata-check.sh
   â”œâ”€ å¾ªç¯æ£€æŸ¥å¯¼å…¥çŠ¶æ€
   â””â”€ æ¸…ç†å…±äº«ç›®å½•

4. ç”ŸæˆæŠ¥å‘Š (report)
   â”œâ”€ æ±‡æ€»æ‰§è¡Œç»“æœ
   â”œâ”€ è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
   â””â”€ æ˜¾ç¤ºç›¸å…³é“¾æ¥
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™è¦æ±‚**
   - **å¿…é¡»é…ç½® PAT Token**ï¼šéœ€è¦åˆ›å»º `PAT_TOKEN` Secret ç”¨äºè®¿é—®é…ç½®ä»“åº“
     - é»˜è®¤çš„ `GITHUB_TOKEN` åªæœ‰å½“å‰ä»“åº“æƒé™ï¼Œæ— æ³•è®¿é—®å…¶ä»–ä»“åº“
     - è¯¦ç»†é…ç½®æ­¥éª¤è¯·å‚è€ƒï¼š[PAT Token é…ç½®æŒ‡å—](docs/PAT-TOKEN-SETUP.md)
   - ç¡®ä¿ self-hosted runner æœ‰æ–‡ä»¶ç³»ç»Ÿè¯»å†™æƒé™

2. **é…ç½®æ–‡ä»¶**
   - ç¡®ä¿ `env.conf` ä¸­é…ç½®äº†æ‰€æœ‰ç¯å¢ƒçš„ Tapdata åœ°å€
   - ç¡®ä¿ `project.conf` ä¸­é…ç½®äº†æ‰€æœ‰é¡¹ç›®åˆ†ç»„çš„ä»“åº“åç§°

3. **è¶…æ—¶è®¾ç½®**
   - å‡†å¤‡é…ç½®ï¼š5åˆ†é’Ÿ
   - å¯¼å…¥é…ç½®ï¼š20åˆ†é’Ÿ
   - éªŒè¯ç»“æœï¼š5åˆ†é’Ÿ
   - ç”ŸæˆæŠ¥å‘Šï¼š2åˆ†é’Ÿ

4. **é”™è¯¯å¤„ç†**
   - å¯¼å…¥å¤±è´¥æ—¶ä¼šæ‰“å°è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - å…±äº«ç›®å½•ä¼šåœ¨æœ€åä¸€ä¸ª job å®Œæˆåè‡ªåŠ¨æ¸…ç†
   - å¯ä»¥é€šè¿‡ GitHub Actions ç•Œé¢é‡è¯•å¤±è´¥çš„ job

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Tapdata é…ç½®éƒ¨ç½² Workflow è¯¦ç»†æ–‡æ¡£](.github/workflows/deploy-README.md)
- [GitHub Actions å®˜æ–¹æ–‡æ¡£](https://docs.github.com/en/actions)
- [Self-Hosted Runner é…ç½®æŒ‡å—](https://docs.github.com/en/actions/hosting-your-own-runners)

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. æ–°å¢å·¥ä½œæµæ—¶ï¼Œè¯·åœ¨ `.github/workflows/` ç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„ YAML æ–‡ä»¶
2. æ–°å¢è„šæœ¬æ—¶ï¼Œè¯·åœ¨ `scripts/` ç›®å½•ä¸‹åˆ›å»ºï¼Œå¹¶æ·»åŠ æ‰§è¡Œæƒé™
3. ä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶ï¼Œè¯·ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼Œé¿å…å½±å“ç°æœ‰æµç¨‹
4. å»ºè®®ä¸ºå¤æ‚çš„å·¥ä½œæµç¼–å†™ç‹¬ç«‹çš„ README æ–‡æ¡£

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2024-01-13
- âœ¨ åˆå§‹åŒ–é¡¹ç›®ç»“æ„
- âœ¨ æ·»åŠ  Tapdata é…ç½®éƒ¨ç½²å·¥ä½œæµ
- âœ¨ æ·»åŠ é…ç½®å¯¼å…¥å’ŒçŠ¶æ€æ£€æŸ¥è„šæœ¬
- ğŸ“ å®Œå–„é¡¹ç›®æ–‡æ¡£

---

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤ GitHub Issue
- è”ç³»é¡¹ç›®ç»´æŠ¤è€…

---

**License:** MIT